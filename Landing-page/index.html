<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=320, user-scalable=no" />
  <title>Live Camera Capture</title>

  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f5f5f5;
      font-family: Arial, sans-serif;
    }

    .container {
      text-align: center;
      background: #ffffff;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 320px;
      height: 460px;
      box-sizing: border-box;
      overflow: hidden;
    }

    .camera-frame {
      width: 100%;
      height: 240px;
      border: 2px solid #ccc;
      border-radius: 10px;
      margin-bottom: 20px;
      overflow: hidden;
      background: #f0f0f0;
    }

    video, #frozenImg {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
      display: block;
    }

    #frozenImg {
      display: none;
    }

    .shutter-wrap {
      display: flex;
      justify-content: center;
      margin-bottom: 12px;
    }

    .shutter-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 4px solid #ccc;
      background: white;
      cursor: pointer;
      position: relative;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s;
    }

    .shutter-btn:active {
      transform: scale(0.9);
    }

    .shutter-btn .inner {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: #007bff;
      transition: background 0.2s;
    }

    .shutter-btn:disabled {
      cursor: not-allowed;
    }

    .shutter-btn:disabled .inner {
      background: #ccc;
    }

    .sending-text {
      display: none;
      font-size: 14px;
      color: #666;
      margin-top: 8px;
    }

    #resultMsg {
      display: none;
      padding: 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
    }

    #resultMsg.matched {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    #resultMsg.not-matched {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    #resultMsg .name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    #resultMsg .status,
    #resultMsg .confidence {
      font-size: 14px;
      font-weight: normal;
    }

    #resultMsg .confidence {
      margin-top: 2px;
    }

      </style>
</head>

<body>
  <div class="container">
    <h2 style="margin: 8px 0 2px;">Capture Your Photo</h2>
    <p style="color: #666; font-size: 13px; margin: 0 0 8px;">Look straight to me</p>

    <div class="camera-frame">
      <video id="preview" autoplay playsinline></video>
      <img id="frozenImg" alt="Captured Photo" />
    </div>

    <div class="shutter-wrap">
      <button class="shutter-btn" id="captureBtn" onclick="capturePhoto()">
        <div class="inner"></div>
      </button>
    </div>
    <p class="sending-text" id="sendingText">üì§ Sending your photo...</p>

    <div id="resultMsg"></div>

    <canvas id="canvas" style="display:none;"></canvas>
  </div>

  <script>
    let stream;

    const webhookURL = "https://eva-ramanik.app.n8n.cloud/webhook/face-match";
    const AGENT_ID = "agent_3701kh0eb96rf34vc2rgyew10wjk";

    // Auto-start camera on page load
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
        document.getElementById("preview").srcObject = stream;
      } catch (err) {
        console.error("Camera error:", err);
        if (err.name === "NotAllowedError") {
          alert("Camera permission denied. Please allow camera access and reload.");
        } else if (err.name === "NotReadableError") {
          alert("Camera is in use by another app. Please close it and reload.");
        } else {
          alert("Unable to access camera: " + err.message);
        }
      }
    }
    startCamera();

    function capturePhoto() {
      const video = document.getElementById("preview");
      const canvas = document.getElementById("canvas");
      const frozenImg = document.getElementById("frozenImg");

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);

      // Freeze: show captured frame, hide live video
      frozenImg.src = canvas.toDataURL("image/jpeg");
      frozenImg.style.display = "block";
      video.style.display = "none";

      // Stop camera stream
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }

      canvas.toBlob(blob => {
        sendToN8N(blob, "photo.jpg");
      }, "image/jpeg");
    }

    function sendToN8N(blob, filename) {
      const formData = new FormData();
      formData.append("file", blob, filename);
      
      const btn = document.getElementById("captureBtn");
      const sendingText = document.getElementById("sendingText");
      
      // Show loading state
      btn.disabled = true;
      sendingText.style.display = "block";

      fetch(webhookURL, {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        console.log("Webhook response:", JSON.stringify(data, null, 2));

        const vars = data.conversation_initiation_data?.variables || {};
        const name = vars.name || "Unknown";
        const status = vars.status || "UNKNOWN";
        const confidence = vars.confidence || "N/A";

        // Save variables to localStorage
        localStorage.setItem("name", name);
        localStorage.setItem("status", status);
        localStorage.setItem("confidence", confidence);

        // Hide shutter and sending text
        btn.parentElement.style.display = "none";
        sendingText.style.display = "none";

        // Show result message
        const resultMsg = document.getElementById("resultMsg");
        const isMatched = status === "MATCHED";
        resultMsg.className = isMatched ? "matched" : "not-matched";
        resultMsg.innerHTML = `
          <div class="name">${isMatched ? "üëã" : "‚ùå"} ${name}</div>
          <div class="status">Status: ${status}</div>
          <div class="confidence">Confidence: ${confidence}</div>
        `;
        resultMsg.style.display = "block";

        // After 5 seconds: redirect if MATCHED, otherwise refresh
        if (isMatched) {
          const elName = encodeURIComponent(name);
          const elStatus = encodeURIComponent(status);
          const elConfidence = encodeURIComponent(confidence);
          const evaUrl = `https://evafrt.vercel.app/?name=${elName}&status=${elStatus}&confidence=${elConfidence}`;
          setTimeout(() => {
            window.location.href = evaUrl;
          }, 5000);
        } else {
          setTimeout(() => {
            window.location.reload();
          }, 5000);
        }
      })
      .catch(err => {
        console.error("Webhook error:", err);

        // Hide shutter and sending text
        btn.parentElement.style.display = "none";
        sendingText.style.display = "none";

        // Show error message
        const resultMsg = document.getElementById("resultMsg");
        resultMsg.className = "not-matched";
        resultMsg.innerHTML = `
          <div class="name">‚ö†Ô∏è Error</div>
          <div class="status">Could not process your photo</div>
        `;
        resultMsg.style.display = "block";

        // Refresh page after 5 seconds on error
        setTimeout(() => {
          window.location.reload();
        }, 5000);
      });
    }

  </script>
</body>
</html>
